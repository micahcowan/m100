5 CLS
10 R=1
20 SX=INT(240/2)
30 SY=INT(64/2)
40 RD=0.5
50 DD=1.0001
55 DE=1.0005
60 LET PI=ATN(1)*4
65 AD=PI/2.005
67 AD=2*PI/5.15
70 X0=SX:Y0=SY
90 Y1=SY+SIN(A)*R
95 IF R>200 THEN END '*****
100 X1=SX+COS(A)*R
105 IF R>SY THEN GOTO 300
110 LINE (X0,Y0) - (X1,Y1)
115 X0=X1:Y0=Y1
130 A=A+AD
140 R=R+RD
150 RD=RD*DD
160 DD=DD*DE
200 GOTO 90
205 END
300 ' check for and handle out-of-bound lines
307 X2=X0:Y2=Y0:X3=X1:Y3=Y1
310 IF X2>=0 AND X2<240 AND Y2>=0 AND Y2<64 THEN GOTO 400
315 ' an initial portion of the line is out of bounds
317 IF (Y0<0 AND Y1<0) OR (Y0>=64 AND Y1>=64) OR (X0<0 AND X1<0) OR (X0>=240 AND X1>=240) THEN GOTO 600 'no visible segment!
320 IF Y2>=64 THEN NY=63:GOSUB 1000:X2=NX:Y2=NY:GOTO 340
330 IF Y2<0 THEN NY=0:GOSUB 1000:X2=NX:Y2=NY:GOTO 340
340 IF X2>=240 THEN NX=239:GOSUB 1100:X2=NX:Y2=NY:GOTO 400
350 IF X2<0 THEN NX=0:GOSUB 1100:X2=NX:Y2=NY:GOTO 400
395 ' the in-bounds portion of the line
396 ' X2,Y2 is start of in-bounds line
397 ' segment; X3,Y3 is the end of it.
400 IF X1>=0 AND X1<240 AND Y1>=0 AND Y1<64 THEN GOTO 500
410 IF Y3>=64 THEN NY=63:GOSUB 1000:X3=NX:Y3=NY::GOTO 440
420 IF Y3<0 THEN NY=0:GOSUB 1000:X3=NX:Y3=NY:GOTO 440
440 IF X3>=240 THEN NX=239:GOSUB 1100:X3=NX:Y3=NY:GOTO 500
450 IF X3<0 THEN NX=0:GOSUB 1100:X3=NX:Y3=NY:GOTO 500
495 ' draw the line
500 ' first, make sure we don't draw illegal lines
505 IF X2<0 OR X2>=240 OR X3<0 OR X3>=240 OR Y2<0 OR Y2>=64 OR Y3<0 OR Y3>=64 THEN GOTO 600
510 LINE (X2,Y2)-(X3,Y3)
600 GOTO 115
1000 NX=X2+(NY-Y2)/(Y3-Y2)*(X3-X2)
1010 RETURN
1100 NY=Y2+(NX-X2)/(X3-X2)*(Y3-Y2)
1110 RETURN
